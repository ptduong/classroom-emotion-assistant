
<!DOCTYPE html>
<html>
<head>
  <title>Emotion Recognition Assistant</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Th∆∞ vi·ªán AI -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #webcam-container, #label-container { margin-top: 20px; }
    #robotRespond { margin-top: 30px; font-size: 1.2em; color: #0078D7; }
    #chat-box { margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px; }
    #chat-log { height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    #user-input { width: 80%; padding: 10px; }
    #send-btn { padding: 10px; }
    #emotion-history { margin-top: 40px; }
    #emotion-table { margin: 0 auto; border-collapse: collapse; width: 60%; }
    #emotion-table th, #emotion-table td { border: 1px solid #ccc; padding: 8px; }
    #emotion-table th { background: #f0f0f0; }
    #control-btns { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Emotion Recognition Assistant</h1>
  <p>Using Teachable Machine Image Model</p>
  <div id="webcam-container"></div>
  <div id="label-container"></div>
  <div id="control-btns">
    <button type="button" onclick="init()">Start</button>
    <button type="button" onclick="stopRecognition()">Stop</button>
    <button type="button" onclick="clearEmotionHistory()">X√≥a l·ªãch s·ª≠ c·∫£m x√∫c</button>
    <button type="button" onclick="exportEmotionHistory()">Xu·∫•t l·ªãch s·ª≠</button>
  </div>
  <div id="robotRespond">Robot ƒëang ch·ªù nh·∫≠n di·ªán bi·ªÉu c·∫£m...</div>

  <div id="chat-box">
    <h3>Giao ti·∫øp v·ªõi Robot</h3>
    <div id="chat-log"></div>
    <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn..." />
    <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
  </div>

  <div id="emotion-history">
    <h3>L·ªãch s·ª≠ c·∫£m x√∫c</h3>
    <table id="emotion-table">
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>C·∫£m x√∫c</th>
        </tr>
      </thead>
      <tbody id="emotion-table-body">
      </tbody>
    </table>
  </div>

  <script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/kBhMIHxeP/";
    let model, webcam, labelContainer, maxPredictions;
    let lastEmotion = "";
    let lastEmotionTime = 0;
    let loopActive = false;

    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      const flip = true;
      webcam = new tmImage.Webcam(200, 200, flip);
      await webcam.setup();
      await webcam.play();

      document.getElementById("webcam-container").innerHTML = "";
      document.getElementById("webcam-container").appendChild(webcam.canvas);

      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }

      loopActive = true;
      window.requestAnimationFrame(loop);

      loadEmotionHistory();
    }

    function stopRecognition() {
      loopActive = false;
      if (webcam) {
        webcam.stop();
      }
      document.getElementById("robotRespond").innerText = "Robot ƒë√£ d·ª´ng nh·∫≠n di·ªán bi·ªÉu c·∫£m.";
    }

    async function loop() {
      if (!loopActive) return;
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let maxProb = 0;
      let maxClass = "";
      for (let i = 0; i < maxPredictions; i++) {
        const prob = prediction[i].probability;
        const className = prediction[i].className;
        labelContainer.childNodes[i].innerHTML = className + ": " + (prob * 100).toFixed(2) + "%";
        if (prob > maxProb) {
          maxProb = prob;
          maxClass = className;
        }
      }
      let respondText = "";
      switch (maxClass) {
        case "Happy":
          respondText = "üòä Robot nh·∫≠n th·∫•y b·∫°n ƒëang vui! H√£y gi·ªØ tinh th·∫ßn t√≠ch c·ª±c nh√©!";
          break;
        case "Sad":
          respondText = "üò¢ Robot nh·∫≠n th·∫•y b·∫°n ƒëang bu·ªìn. N·∫øu c·∫ßn chia s·∫ª, h√£y n√≥i v·ªõi th·∫ßy c√¥ ho·∫∑c b·∫°n b√® nh√©!";
          break;
        case "Surprised":
          respondText = "üòÆ C√≥ ƒëi·ªÅu g√¨ l√†m b·∫°n ng·∫°c nhi√™n ph·∫£i kh√¥ng?";
          break;
        case "Angry":
          respondText = "üò† Robot nh·∫≠n th·∫•y b·∫°n ƒëang t·ª©c gi·∫≠n. H√£y h√≠t th·ªü s√¢u v√† b√¨nh tƒ©nh l·∫°i nh√©!";
          break;
        default:
          respondText = "ü§ñ Robot ƒëang nh·∫≠n di·ªán bi·ªÉu c·∫£m c·ªßa b·∫°n...";
      }
      document.getElementById("robotRespond").innerText = respondText;

      const now = Date.now();
      if (maxClass !== lastEmotion || now - lastEmotionTime > 10000) {
        addEmotionHistory(maxClass);
        lastEmotion = maxClass;
        lastEmotionTime = now;
      }
    }

    function addEmotionHistory(emotion) {
      const tableBody = document.getElementById("emotion-table-body");
      const now = new Date();
      const timeStr = now.toLocaleString();

      const row = document.createElement("tr");
      const timeCell = document.createElement("td");
      const emotionCell = document.createElement("td");
      timeCell.textContent = timeStr;
      emotionCell.textContent = emotion;
      row.appendChild(timeCell);
      row.appendChild(emotionCell);
      if (tableBody.firstChild) {
        tableBody.insertBefore(row, tableBody.firstChild);
      } else {
        tableBody.appendChild(row);
      }

      let history = JSON.parse(localStorage.getItem("emotionHistory") || "[]");
      history.unshift({ time: timeStr, emotion: emotion });
      localStorage.setItem("emotionHistory", JSON.stringify(history));
    }

    function loadEmotionHistory() {
      const history = JSON.parse(localStorage.getItem("emotionHistory") || "[]");
      const tableBody = document.getElementById("emotion-table-body");
      tableBody.innerHTML = "";
      history.forEach(entry => {
        const row = document.createElement("tr");
        const timeCell = document.createElement("td");
        const emotionCell = document.createElement("td");
        timeCell.textContent = entry.time;
        emotionCell.textContent = entry.emotion;
        row.appendChild(timeCell);
        row.appendChild(emotionCell);
        tableBody.appendChild(row);
      });
    }

    function clearEmotionHistory() {
      localStorage.removeItem("emotionHistory");
      document.getElementById("emotion-table-body").innerHTML = "";
    }

    function exportEmotionHistory() {
      const history = JSON.parse(localStorage.getItem("emotionHistory") || "[]");
      let csv = "Th·ªùi gian,C·∫£m x√∫c\n";
      history.forEach(entry => {
        csv += `"${entry.time}","${entry.emotion}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "emotion_history.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function sendMessage() {
      const input = document.getElementById("user-input");
      const chatLog = document.getElementById("chat-log");
      const message = input.value.trim();
      if (message !== "") {
        const userMsg = document.createElement("div");
        userMsg.textContent = "B·∫°n: " + message;
        chatLog.appendChild(userMsg);
        const robotMsg = document.createElement("div");
        robotMsg.textContent = "Robot: C·∫£m ∆°n b·∫°n ƒë√£ chia s·∫ª!";
        chatLog.appendChild(robotMsg);
        input.value = "";
        chatLog.scrollTop = chatLog.scrollHeight;
      }
    }
  </script>
</body>
</html>
